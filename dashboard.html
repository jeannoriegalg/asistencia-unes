<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard UNES - TIC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar-unes { background: #212529; color: white; padding: 15px; border-bottom: 4px solid #0d6efd; }
        .card-custom { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s; }
        .card-custom:hover { transform: translateY(-5px); }
        .stat-number { font-size: 2.5rem; font-weight: bold; }
        .chart-container { position: relative; height: 280px; width: 100%; }
        .table-alerta { font-size: 0.85rem; }
        .badge-alerta { background-color: #f8d7da; color: #842029; font-weight: bold; }
    </style>
</head>
<body>

<nav class="navbar-unes text-center shadow-sm mb-4">
    <div class="container d-flex justify-content-between align-items-center">
        <h4 class="mb-0">üìä DASHBOARD TIC UNES</h4>
        <div class="btn-group">
            <a href="index.html" class="btn btn-sm btn-outline-light">Pasar Lista</a>
            <a href="reporte.html" class="btn btn-sm btn-outline-warning">Reportes</a>
        </div>
    </div>
</nav>

<div class="container">
    <div id="loading" class="text-center my-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">Analizando base de datos en tiempo real...</p>
    </div>

    <div id="dashboardContent" style="display:none;">
        <div class="row g-3 mb-4 text-center">
            <div class="col-6 col-md-3">
                <div class="card card-custom p-3">
                    <small class="text-muted text-uppercase fw-bold">Matr√≠cula</small>
                    <div id="statTotal" class="stat-number text-dark">0</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-custom p-3">
                    <small class="text-muted text-uppercase fw-bold">Asistencia Gral</small>
                    <div id="statPromedio" class="stat-number text-success">0%</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-custom p-3">
                    <small class="text-muted text-uppercase fw-bold">En Riesgo</small>
                    <div id="statRiesgo" class="stat-number text-danger">0</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-custom p-3">
                    <small class="text-muted text-uppercase fw-bold">Ambientes</small>
                    <div id="statAmbientes" class="stat-number text-primary">0</div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-5">
                <div class="card card-custom p-4 h-100">
                    <h6 class="fw-bold mb-3">Estado Global de Asistencia</h6>
                    <div class="chart-container">
                        <canvas id="chartDona"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-7">
                <div class="card card-custom p-4 h-100">
                    <h6 class="fw-bold mb-3 text-danger">‚ö†Ô∏è Alerta Temprana: Menor Asistencia</h6>
                    <div class="table-responsive">
                        <table class="table table-hover table-alerta">
                            <thead class="table-light">
                                <tr>
                                    <th>Alumno</th>
                                    <th>Ambiente</th>
                                    <th class="text-center">%</th>
                                </tr>
                            </thead>
                            <tbody id="listaAlerta">
                                </tbody>
                        </table>
                    </div>
                    <small class="text-muted mt-auto">* Listado de los 5 alumnos con mayor √≠ndice de inasistencia.</small>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-custom p-4">
                    <h6 class="fw-bold mb-3 text-primary">Comparativa de Asistencia por Ambiente (%)</h6>
                    <div class="chart-container">
                        <canvas id="chartBarras"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbx8UNrppO-8MnOTkN0EsE4XV89dEjZ_pH3z8Zx_X6ObiOX_qAJkzkTTNJIHvdX89CiIBA/exec'; // <--- PEGA TU URL

    window.onload = async () => {
        try {
            const res = await fetch(API_URL + "?modo=reporte");
            const data = await res.json();
            procesarDashboard(data);
        } catch (e) {
            document.getElementById('loading').innerHTML = "Error al conectar con la base de datos.";
        }
    };

    function procesarDashboard(data) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';

        let totales = 0, presentes = 0, riesgo = 0;
        let ambientesMap = {};
        
        // Calcular porcentajes individuales y mapear ambientes
        let alumnosCalculados = data.map(a => {
            let pct = Math.round((a.presentes / a.total) * 100);
            totales += a.total;
            presentes += a.presentes;
            if (pct < 75) riesgo++;

            if (!ambientesMap[a.ambiente]) ambientesMap[a.ambiente] = { p: 0, t: 0 };
            ambientesMap[a.ambiente].p += a.presentes;
            ambientesMap[a.ambiente].t += a.total;

            return { ...a, pct };
        });

        // 1. LLENAR TARJETAS
        document.getElementById('statTotal').innerText = data.length;
        document.getElementById('statPromedio').innerText = Math.round((presentes / totales) * 100) + "%";
        document.getElementById('statRiesgo').innerText = riesgo;
        document.getElementById('statAmbientes').innerText = Object.keys(ambientesMap).length;

        // 2. LISTA DE ALERTA (Top 5 peor asistencia)
        const topPeores = [...alumnosCalculados].sort((a, b) => a.pct - b.pct).slice(0, 5);
        document.getElementById('listaAlerta').innerHTML = topPeores.map(a => `
            <tr>
                <td class="fw-bold">${a.nombre}</td>
                <td>${a.ambiente}</td>
                <td class="text-center"><span class="badge badge-alerta p-2 rounded">${a.pct}%</span></td>
            </tr>
        `).join('');

        // 3. GR√ÅFICO DONA
        new Chart(document.getElementById('chartDona'), {
            type: 'doughnut',
            data: {
                labels: ['Asistencias', 'Inasistencias'],
                datasets: [{
                    data: [presentes, totales - presentes],
                    backgroundColor: ['#198754', '#dee2e6'],
                    borderWidth: 0
                }]
            },
            options: { maintainAspectRatio: false, cutout: '70%' }
        });

        // 4. GR√ÅFICO BARRAS
        const etiquetas = Object.keys(ambientesMap);
        const valores = etiquetas.map(k => Math.round((ambientesMap[k].p / ambientesMap[k].t) * 100));

        new Chart(document.getElementById('chartBarras'), {
            type: 'bar',
            data: {
                labels: etiquetas,
                datasets: [{
                    label: '% Asistencia',
                    data: valores,
                    backgroundColor: '#0d6efd',
                    borderRadius: 5
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });
    }
</script>
</body>
</html>